<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAAI Experiment Service Interaction Flow (v2)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            background-color: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            padding: 25px;
        }
        h1, h2 {
            color: #9cdcfe;
            border-bottom: 2px solid #4a4a4a;
            padding-bottom: 10px;
        }
        .mermaid {
            background-color: #2a2d34;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
        }
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 20px;
        }
        .service-card {
            background-color: #2a2d34;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .service-card h3 {
            margin-top: 0;
            color: #569cd6;
        }
        .service-card code {
            background-color: #1e1e1e;
            color: #ce9178;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "Fira Code", "Courier New", monospace;
        }
        .service-card ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        .service-card li {
            margin-bottom: 8px;
        }
        .function-list {
            margin-top: 15px;
            border-top: 1px solid #4a4a4a;
            padding-top: 15px;
        }
        .function-list h4 {
            margin-top: 0;
            color: #4ec9b0;
        }
        .function-list dl {
            margin: 0;
        }
        .function-list dt {
            font-weight: bold;
            color: #dcdcaa;
            margin-top: 10px;
        }
        .function-list dd {
            margin-left: 20px;
            font-size: 0.9em;
            color: #c8c8c8;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>MAAI Experiment Service Interaction Flow (v2)</h1>
        <p>This document provides an updated graphical and textual overview of the service interactions within the repository when <code>run_experiment.py</code> is executed. The architecture remains centered on the <strong>ExperimentOrchestrator</strong>, which now leverages a new <strong>PublicHistoryService</strong> and a unified <strong>ExperimentLogger</strong>.</p>

        <h2>Execution Sequence Diagram</h2>
        <div class="mermaid">
sequenceDiagram
    actor User
    participant EntryPoint as "run_experiment.py"
    participant Runner as "runners/single.py"
    participant DM as "DeliberationManager"
    participant EO as "ExperimentOrchestrator"
    participant CM as "ConfigManager"
    participant PHS as "PublicHistoryService"
    participant ConvS as "ConversationService"
    participant MemS as "MemoryService"
    participant ConS as "ConsensusService"
    participant EvalS as "EvaluationService"
    participant Logger as "ExperimentLogger"

    User->>EntryPoint: Executes python run_experiment.py --config [name]
    activate EntryPoint
    EntryPoint->>Runner: run_experiment_sync(config)
    activate Runner

    Runner->>CM: load_config_from_file()
    activate CM
    CM-->>Runner: ExperimentConfig
    deactivate CM

    Runner->>DM: run_single_experiment(config)
    activate DM

    DM->>EO: run_experiment(config)
    activate EO

    EO->>Logger: __init__(config)
    activate Logger
    Logger-->>EO: Logger instance created
    deactivate Logger

    EO->>PHS: __init__(config)
    activate PHS
    PHS-->>EO: PHS instance created
    deactivate PHS

    Note over EO: Phase 1: Initialization
    EO->>EO: _initialize_agents()
    EO->>MemS: initialize_agent_memory() for each agent
    activate MemS
    MemS-->>EO: memories initialized
    deactivate MemS

    Note over EO: Phase 2: Initial Likert Assessment
    EO->>ConvS: conduct_initial_likert_assessment()
    activate ConvS
    ConvS->>EvalS: conduct_initial_assessment()
    activate EvalS
    EvalS-->>ConvS: InitialEvaluationResponses
    deactivate EvalS
    ConvS->>Logger: log_initial_evaluation() for each agent
    ConvS-->>EO: InitialEvaluationResponses
    deactivate ConvS

    Note over EO: Phase 3: Deliberation Loop
    loop Deliberation Rounds
        EO->>ConvS: generate_speaking_order()
        activate ConvS
        ConvS-->>EO: Speaking Order
        deactivate ConvS

        EO->>ConvS: conduct_round()
        activate ConvS
        Note right of ConvS: For each agent in order...
        ConvS->>PHS: build_public_context()
        activate PHS
        PHS-->>ConvS: Public context string
        deactivate PHS
        ConvS->>MemS: update_agent_memory()
        activate MemS
        MemS->>Logger: log_memory_generation()
        MemS-->>ConvS: New MemoryEntry
        deactivate MemS
        ConvS->>ConvS: _generate_public_communication()
        ConvS->>Logger: log_communication()
        ConvS-->>EO: Transcript updated
        deactivate ConvS

        alt Summarized History Mode
            EO->>PHS: generate_round_summary()
            activate PHS
            PHS-->>EO: RoundSummary object
            deactivate PHS
        end

        EO->>ConS: detect_consensus()
        activate ConS
        ConS-->>EO: Round ConsensusResult
        deactivate ConS
        alt Consensus Reached
            EO->>EO: break loop
        end
    end

    Note over EO: Phase 4: Post-Consensus Evaluation
    EO->>EvalS: conduct_parallel_evaluation()
    activate EvalS
    EvalS-->>EO: Final EvaluationResponses
    deactivate EvalS

    Note over EO: Phase 5 & 6: Finalize & Log
    EO->>EO: _collect_feedback()
    EO->>EO: _finalize_results()
    EO->>Logger: log_final_consensus() for each agent
    EO->>Logger: log_experiment_completion()

    Note over EO: Phase 7: Export
    EO->>Logger: export_unified_json()
    activate Logger
    Logger-->>EO: File path to single JSON
    deactivate Logger

    EO-->>DM: ExperimentResults
    deactivate EO
    DM-->>Runner: ExperimentResults
    deactivate DM
    Runner-->>EntryPoint: Prints summary to console
    deactivate Runner
    EntryPoint-->>User: Exit
    deactivate EntryPoint
        </div>

        <h2>Core Service Descriptions</h2>
        <div class="service-grid">
            <div class="service-card">
                <h3>ExperimentOrchestrator</h3>
                <code>src/maai/services/experiment_orchestrator.py</code>
                <p><strong>Role: The Conductor</strong></p>
                <p>The central coordinator that manages the high-level sequence of the experiment. It initializes and coordinates all other services.</p>
                <ul>
                    <li><strong>Calls:</strong> All other services.</li>
                    <li><strong>Called by:</strong> <code>DeliberationManager</code>.</li>
                </ul>
                <div class="function-list">
                    <h4>Key Functions</h4>
                    <dl>
                        <dt><code>run_experiment(config)</code></dt>
                        <dd><strong>Input:</strong> <code>ExperimentConfig</code>.<br/><strong>Output:</strong> <code>ExperimentResults</code>.<br/>The main entry point to execute a full experiment, from initialization to data export.</dd>
                        
                        <dt><code>_run_deliberation_rounds()</code></dt>
                        <dd><strong>Input:</strong> None.<br/><strong>Output:</strong> <code>ConsensusResult</code>.<br/>Manages the core loop, calling services for speaking order, conversation, and consensus checks.</dd>
                    </dl>
                </div>
            </div>
            <div class="service-card">
                <h3>ConversationService</h3>
                <code>src/maai/services/conversation_service.py</code>
                <p><strong>Role: The Flow Controller</strong></p>
                <p>Manages the turn-by-turn dynamics of the deliberation. It determines who speaks when and orchestrates agent interactions within a round.</p>
                <ul>
                    <li><strong>Calls:</strong> <code>PublicHistoryService</code>, <code>MemoryService</code>, <code>EvaluationService</code>, <code>ExperimentLogger</code>.</li>
                    <li><strong>Called by:</strong> <code>ExperimentOrchestrator</code>.</li>
                </ul>
                <div class="function-list">
                    <h4>Key Functions</h4>
                    <dl>
                        <dt><code>conduct_round(round_context, ...)</code></dt>
                        <dd><strong>Input:</strong> <code>RoundContext</code>, services.<br/><strong>Output:</strong> List of new <code>DeliberationResponse</code>.<br/>Executes a single round by getting context from PHS, updating memory via MemoryService, and generating agent messages.</dd>

                        <dt><code>conduct_initial_likert_assessment(...)</code></dt>
                        <dd><strong>Input:</strong> Agents, EvaluationService.<br/><strong>Output:</strong> List of <code>AgentEvaluationResponse</code>.<br/>Triggers the initial data collection and logs it.</dd>
                    </dl>
                </div>
            </div>
            <div class="service-card">
                <h3>PublicHistoryService</h3>
                <code>src/maai/services/public_history_service.py</code>
                <p><strong>Role: The Context Builder</strong></p>
                <p>Manages the shared conversation history provided to agents. It can provide the full transcript or generate summaries.</p>
                <ul>
                    <li><strong>Calls:</strong> <code>SummaryAgent</code>.</li>
                    <li><strong>Called by:</strong> <code>ConversationService</code>, <code>ExperimentOrchestrator</code>.</li>
                </ul>
                <div class="function-list">
                    <h4>Key Functions</h4>
                    <dl>
                        <dt><code>build_public_context(...)</code></dt>
                        <dd><strong>Input:</strong> Round state, transcript.<br/><strong>Output:</strong> Formatted context string.<br/>Constructs the public history for an agent based on the configured mode (full or summarized).</dd>

                        <dt><code>generate_round_summary(...)</code></dt>
                        <dd><strong>Input:</strong> Round number, responses.<br/><strong>Output:</strong> <code>RoundSummary</code> object.<br/>Uses a dedicated SummaryAgent to create a condensed summary of a round's discussion.</dd>
                    </dl>
                </div>
            </div>
            <div class="service-card">
                <h3>MemoryService</h3>
                <code>src/maai/services/memory_service.py</code>
                <p><strong>Role: The Scribe</strong></p>
                <p>Manages the internal, private state of each agent. It prompts agents to reflect and form a strategy before they speak.</p>
                <ul>
                    <li><strong>Calls:</strong> <code>ExperimentLogger</code>.</li>
                    <li><strong>Called by:</strong> <code>ConversationService</code>.</li>
                </ul>
                <div class="function-list">
                    <h4>Key Functions</h4>
                    <dl>
                        <dt><code>update_agent_memory(...)</code></dt>
                        <dd><strong>Input:</strong> Agent, round number, transcript.<br/><strong>Output:</strong> New <code>MemoryEntry</code>.<br/>Generates a new private memory entry for an agent and logs the result.</dd>
                    </dl>
                </div>
            </div>
            <div class="service-card">
                <h3>ConsensusService</h3>
                <code>src/maai/services/consensus_service.py</code>
                <p><strong>Role: The Judge</strong></p>
                <p>Determines if the group has reached an agreement by checking agent choices against a defined rule (e.g., unanimity).</p>
                <ul>
                    <li><strong>Calls:</strong> None.</li>
                    <li><strong>Called by:</strong> <code>ExperimentOrchestrator</code>.</li>
                </ul>
                <div class="function-list">
                    <h4>Key Functions</h4>
                    <dl>
                        <dt><code>detect_consensus(responses)</code></dt>
                        <dd><strong>Input:</strong> List of <code>DeliberationResponse</code>.<br/><strong>Output:</strong> <code>ConsensusResult</code>.<br/>Analyzes the latest choice from each agent to check if the consensus condition has been met.</dd>
                    </dl>
                </div>
            </div>
            <div class="service-card">
                <h3>EvaluationService</h3>
                <code>src/maai/services/evaluation_service.py</code>
                <p><strong>Role: The Surveyor</strong></p>
                <p>Conducts pre- and post-deliberation assessments of agent preferences using a Likert scale.</p>
                <ul>
                    <li><strong>Calls:</strong> None.</li>
                    <li><strong>Called by:</strong> <code>ConversationService</code>, <code>ExperimentOrchestrator</code>.</li>
                </ul>
                <div class="function-list">
                    <h4>Key Functions</h4>
                    <dl>
                        <dt><code>conduct_parallel_evaluation(...)</code></dt>
                        <dd><strong>Input:</strong> Agents, consensus result.<br/><strong>Output:</strong> List of <code>AgentEvaluationResponse</code>.<br/>Runs the post-consensus evaluation in parallel for all agents.</dd>
                    </dl>
                </div>
            </div>
            <div class="service-card">
                <h3>ExperimentLogger</h3>
                <code>src/maai/services/experiment_logger.py</code>
                <p><strong>Role: The Archivist</strong></p>
                <p>The new, unified logging system. It collects all experiment data into a single, agent-centric structure and exports it as one JSON file.</p>
                <ul>
                    <li><strong>Calls:</strong> None.</li>
                    <li><strong>Called by:</strong> All other services.</li>
                </ul>
                <div class="function-list">
                    <h4>Key Functions</h4>
                    <dl>
                        <dt><code>log_*(...)</code></dt>
                        <dd>Various methods (e.g., <code>log_initial_evaluation</code>, <code>log_communication</code>) to capture specific events and data points throughout the experiment.</dd>
                        <dt><code>export_unified_json()</code></dt>
                        <dd><strong>Input:</strong> None.<br/><strong>Output:</strong> Path to the exported JSON file.<br/>Serializes the complete, structured experiment data into a single output file.</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });
    </script>

</body>
</html>